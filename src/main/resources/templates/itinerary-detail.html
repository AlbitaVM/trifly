{{>header}}
<main class="main">
  <section class="trip-header">
    <div>
      <h2 class="trip-title">{{itinerary.itineraryName}}</h2>
      <p class="trip-subtitle">{{itinerary.totalDays}} d√≠as en {{itinerary.destination}} ¬∑
        {{itinerary.startDate}} - {{itinerary.finishDate}}</p>
    </div>
    <div class="btn-group">
      {{#itinerary.hasBudget}}
      <a class="btn btn-success fw-bold rounded" href="/budget/{{itinerary.budgetId}}/detail">
        <span class="material-symbols-outlined">payments</span>
        Presupuesto
      </a>
      {{/itinerary.hasBudget}}
      <a class="btn btn-info fw-bold rounded" href="/itinerary/detail/map">
        <span class="material-symbols-outlined">map</span>
        Ver en mapa
      </a>
      <button class="btn btn-warning fw-bold rounded">
        <span class="material-symbols-outlined">download</span>
        Descargar PDF
      </button>
    </div>
  </section>

  {{#itinerary.days}}
  <section class="day-section">
    <h3>Dia {{numberDay}}</h3>
    <ul class="timeline">
      {{#activities}}
      <li>
        <span class="material-symbols-outlined">{{activityTypeIcon}}</span>
        <div class="activity-info">
          <div class="activity-header">
            <p class="activity-name">{{activityName}}</p>
            <span class="activity-type-badge">{{activityTypeName}}</span>
          </div>
          {{#location}}
          <small class="activity-location">
            <span class="material-symbols-outlined" style="font-size: 14px;">location_on</span>
            {{location}}
          </small>
          {{/location}}
          <small class="activity-time">{{timeRange}}</small>
          {{#activityDescription}}
          <p class="activity-description">{{activityDescription}}</p>
          {{/activityDescription}}
        </div>
      </li>
      {{/activities}}
    </ul>
  </section>
  {{/itinerary.days}}

   <!-- SECCI√ìN DEL MAPA CON BOTONES DE D√çA -->
  <section class="map-section" style="margin: 2rem 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h3 style="margin: 0;">üìç Mapa del Itinerario</h3>
      <div id="dayButtons" style="display: flex; gap: 10px;"></div>
    </div>
    <div id="map" style="width: 100%; height: 500px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1;"></div>
    <div id="map-message" style="display: none; padding: 20px; text-align: center; background: #f5f5f5; border-radius: 10px; margin-top: 10px;">
      <p style="color: #999; margin: 0;">No hay ubicaciones geocodificadas para mostrar en el mapa</p>
    </div>
  </section>

  <section class="notes">
    <h3>Notas</h3>
    <div class="notes-box">
      {{#itinerary.notes}}
      <div class="note-item">
        <span class="material-symbols-outlined note-icon">sticky_note_2</span>
        <div class="note-content">
          {{#noteTitle}}
          <h5 class="note-title">{{noteTitle}}</h5>
          {{/noteTitle}}
          {{#noteDescription}}
          <p class="note-description">{{noteDescription}}</p>
          {{/noteDescription}}
          {{^noteTitle}}
          {{^noteDescription}}
          <p class="text-muted">Nota sin contenido</p>
          {{/noteDescription}}
          {{/noteTitle}}
        </div>
      </div>
      {{/itinerary.notes}}

      {{^itinerary.notes}}
      <div class="no-notes">
        <span class="material-symbols-outlined">note_add</span>
        <p class="text-muted">No hay notas asociadas a este itinerario.</p>
        <small class="text-muted">A√±ade notas importantes para recordar durante tu viaje.</small>
      </div>
      {{/itinerary.notes}}
    </div>

    <h3>Recordatorios</h3>
    <div class="notes-box">
      {{#itinerary.reminders}}
      <div class="reminder-item">
        <span class="material-symbols-outlined reminder-icon">notifications</span>
        <div class="reminder-content">
          {{#reminderTitle}}
          <h5 class="reminder-title">{{reminderTitle}}</h5>
          {{/reminderTitle}}
          {{#hasDateTime}}
          <div class="reminder-datetime">
            <span class="material-symbols-outlined">schedule</span>
            <span>{{formattedDateTime}}</span>
          </div>
          {{/hasDateTime}}
          {{#reminderDescription}}
          <p class="reminder-description">{{reminderDescription}}</p>
          {{/reminderDescription}}
        </div>
      </div>
      {{/itinerary.reminders}}
      {{^itinerary.reminders}}
      <div class="empty-state">
        <span class="material-symbols-outlined">alarm_add</span>
        <p class="text-muted">No hay recordatorios</p>
      </div>
      {{/itinerary.reminders}}
    </div>
  </section>
</main>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Leaflet Routing Machine (para rutas) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<div id="dayButtons" style="margin-bottom: 10px;"></div>
<div id="map" style="height: 500px;"></div>

<script>
console.log("üó∫Ô∏è Iniciando mapa con datos desde JSON...");

// IMPORTANTE: Parsear el JSON que viene del backend
var itineraryData = null;
try {
  var jsonString = '{{{itineraryJson}}}';
  console.log("üìÑ JSON recibido (primeros 200 chars):", jsonString.substring(0, 200));
  itineraryData = JSON.parse(jsonString);
  console.log("‚úÖ JSON parseado correctamente:", itineraryData);
} catch (e) {
  console.error("‚ùå Error parseando JSON:", e);
  console.error("JSON string:", '{{{itineraryJson}}}');
  document.getElementById('map').style.display = 'none';
  document.getElementById('map-message').style.display = 'block';
  document.getElementById('map-message').innerHTML = '<p style="color: #d32f2f;">Error cargando datos del itinerario</p>';
}

var map;
var currentPolyline;
var currentMarkers = [];
var routeColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];

document.addEventListener('DOMContentLoaded', function() {
  console.log("‚úÖ DOM cargado");
  if (itineraryData) {
    initializeMap();
  }
});

function initializeMap() {
  console.log("üîç Verificando coordenadas en los d√≠as...");
  
  // Verificar si hay coordenadas
  var hasCoordinates = false;
  if (itineraryData.days) {
    itineraryData.days.forEach(function(day) {
      if (day.activities) {
        day.activities.forEach(function(act) {
          if (act.latitud && act.longitud) {
            hasCoordinates = true;
            console.log("‚úì Encontrada actividad con coordenadas:", act.activityName, act.latitud, act.longitud);
          } else {
            console.log("‚úó Actividad sin coordenadas:", act.activityName);
          }
        });
      }
    });
  }

  if (!hasCoordinates) {
    console.warn("‚ö†Ô∏è No hay coordenadas para mostrar");
    document.getElementById('map').style.display = 'none';
    document.getElementById('map-message').style.display = 'block';
    return;
  }

  document.getElementById('map-message').style.display = 'none';
  document.getElementById('map').style.display = 'block';

  // Crear el mapa
  console.log("üó∫Ô∏è Creando mapa...");
  map = L.map('map').setView([40.4168, -3.7038], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
  }).addTo(map);

  console.log("‚úì Mapa creado");

  // Crear botones por cada d√≠a
  createDayButtons();

  // Mostrar el primer d√≠a autom√°ticamente
  if (itineraryData.days && itineraryData.days.length > 0) {
    var firstDay = itineraryData.days[0].numberDay;
    showDay(firstDay);
  }
}

function createDayButtons() {
  var buttonsDiv = document.getElementById('dayButtons');
  buttonsDiv.innerHTML = '';

  if (!itineraryData.days) return;

  itineraryData.days.forEach(function(day) {
    var button = document.createElement('button');
    button.className = 'day-button';
    button.textContent = 'D√≠a ' + day.numberDay;
    button.onclick = function() {
      showDay(day.numberDay);
    };
    buttonsDiv.appendChild(button);
  });

  console.log("üîò Botones creados:", itineraryData.days.length);
}

function showDay(dayNumber) {
  console.log("üìç Mostrando d√≠a:", dayNumber);

  // Actualizar botones activos
  var buttons = document.querySelectorAll('.day-button');
  buttons.forEach(function(btn) {
    btn.classList.remove('active');
    if (btn.textContent === 'D√≠a ' + dayNumber) {
      btn.classList.add('active');
    }
  });

  // Limpiar marcadores y l√≠neas anteriores
  if (currentPolyline) {
    map.removeLayer(currentPolyline);
  }
  currentMarkers.forEach(function(marker) {
    map.removeLayer(marker);
  });
  currentMarkers = [];

  // Obtener el d√≠a
  var day = null;
  if (itineraryData.days) {
    for (var i = 0; i < itineraryData.days.length; i++) {
      if (itineraryData.days[i].numberDay === dayNumber) {
        day = itineraryData.days[i];
        break;
      }
    }
  }

  if (!day) {
    console.error("‚ùå No se encontr√≥ el d√≠a", dayNumber);
    return;
  }

  if (!day.activities) {
    console.warn("‚ö†Ô∏è El d√≠a no tiene actividades");
    return;
  }

  var coords = [];
  var activityIndex = 0;

  // Agregar marcadores para cada actividad
  day.activities.forEach(function(activity) {
    if (activity.latitud && activity.longitud) {
      activityIndex++;
      
      // Crear icono personalizado
      var iconHtml = '<div class="custom-marker marker-day-' + dayNumber + '">' + activityIndex + '</div>';
      var customIcon = L.divIcon({
        html: iconHtml,
        className: 'custom-div-icon',
        iconSize: [35, 35],
        iconAnchor: [17, 17]
      });

      // Crear popup
      var popupHTML = '<div class="popup-title">' + (activity.activityName || 'Sin nombre') + '</div>';
      
      if (activity.location) {
        popupHTML += '<div class="popup-location">üìç ' + activity.location + '</div>';
      }
      
      if (activity.startTime && activity.startTime !== '00:00:00') {
        var timeText = activity.startTime;
        if (activity.finishTime && activity.finishTime !== '00:00:00') {
          timeText += ' - ' + activity.finishTime;
        }
        popupHTML += '<div class="popup-time">üïê ' + timeText + '</div>';
      }
      
      if (activity.activityDescription) {
        popupHTML += '<div class="popup-description">' + activity.activityDescription + '</div>';
      }

      // Agregar marcador
      var marker = L.marker([activity.latitud, activity.longitud], { icon: customIcon })
        .addTo(map)
        .bindPopup(popupHTML);
      
      currentMarkers.push(marker);
      coords.push([activity.latitud, activity.longitud]);

      console.log("‚úì Marcador agregado:", activity.activityName, "(" + activity.latitud + ", " + activity.longitud + ")");
    }
  });

  // Dibujar ruta entre actividades si hay m√°s de una
  if (coords.length > 1) {
    var color = routeColors[(dayNumber - 1) % routeColors.length];
    currentPolyline = L.polyline(coords, {
      color: color,
      weight: 4,
      opacity: 0.75
    }).addTo(map);

    // Ajustar zoom para ver toda la ruta
    map.fitBounds(currentPolyline.getBounds(), { padding: [50, 50] });
    console.log("üõ£Ô∏è Ruta dibujada con", coords.length, "puntos");
  } else if (coords.length === 1) {
    // Si solo hay un punto, centrarlo
    map.setView(coords[0], 15);
    console.log("üìå Centrado en √∫nico punto");
  } else {
    console.warn("‚ö†Ô∏è No hay coordenadas v√°lidas para el d√≠a", dayNumber);
  }
}
</script>

{{>footer}}